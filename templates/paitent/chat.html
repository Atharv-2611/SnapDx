{% extends "paitent/layout/index.html" %}
{% block title %}Chat{% endblock %} 
{% block content %}

<!-- Chat Interface -->
<div class="flex h-full pt-16">
  <!-- Doctor List Sidebar -->
  <div class="w-80 bg-white border-r border-gray-200 flex flex-col">
    <div class="p-4 border-b border-gray-200">
      <h2 class="text-lg font-medium text-gray-900">Doctors</h2>
      <div class="mt-2">
        <input
          type="text"
          id="doctor-search"
          placeholder="Search doctors..."
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 text-sm"
        />
      </div>
    </div>

    <div class="flex-1 overflow-y-auto">
      <div class="divide-y divide-gray-200" id="doctor-list">
        <!-- Doctor list items will be populated here -->
      </div>
    </div>
  </div>

  <!-- Chat Area -->
  <div class="flex-1 flex flex-col">
    <!-- Chat Header -->
    <div class="bg-white border-b border-gray-200 px-6 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center">
          <div class="flex-shrink-0 h-10 w-10">
            <div
              class="h-10 w-10 rounded-full bg-blue-100 flex items-center justify-center"
            >
              <i class="fas fa-user-md text-blue-600"></i>
            </div>
          </div>
          <div class="ml-4">
            <h3 class="text-lg font-medium text-gray-900" id="chat-doctor-name">
              Select a doctor to start chatting
            </h3>
            <p class="text-sm text-gray-500" id="chat-doctor-status">Online</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Messages Area -->
    <div class="flex-1 overflow-y-auto p-6" id="messages-container">
      <div class="text-center text-gray-500 mt-8">
        <i class="fas fa-comments text-4xl mb-4"></i>
        <p>Select a doctor from the sidebar to start a conversation</p>
      </div>
    </div>

    <!-- Message Input -->
    <div class="bg-white border-t border-gray-200 px-6 py-4">
      <div class="flex items-center space-x-4">
        <button class="p-2 text-gray-400 hover:text-gray-600">
          <i class="fas fa-paperclip"></i>
        </button>
        <div class="flex-1">
          <input
            type="text"
            id="message-input"
            placeholder="Type your message..."
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
            disabled
          />
        </div>
        <button
          id="send-button"
          class="p-2 text-gray-400 hover:text-gray-600"
          disabled
        >
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.socket.io/4.7.5/socket.io.min.js" integrity="sha384-2q0cB8wGvUihk8nU+3GqnYv4vGmW1b2Ywq5zj6k8C3Q5Gq9vZ2W1dZx5mQnq0V7T" crossorigin="anonymous"></script>
<script>
  const patientEmail = "{{ user_email }}";
  let currentDoctorEmail = null;
  let doctors = [];
  let currentRoomId = null;
  const socket = io();

  function populateDoctorList() {
    const doctorList = document.getElementById("doctor-list");
    doctorList.innerHTML = doctors.map(doctor => `
      <div class="p-4 hover:bg-gray-50 cursor-pointer border-l-4 border-transparent ${doctor.doctor_email === currentDoctorEmail ? 'border-blue-500 bg-blue-50' : ''}"
           onclick="selectDoctor('${doctor.doctor_email}')">
        <div class="flex items-center justify-between">
          <div class="flex items-center">
            <div class="flex-shrink-0 h-10 w-10">
              <div class="h-10 w-10 rounded-full bg-blue-100 flex items-center justify-center">
                <span class="text-sm font-medium text-blue-600">${(doctor.doctor_name||'D').charAt(0)}</span>
              </div>
            </div>
            <div class="ml-3">
              <p class="text-sm font-medium text-gray-900">${doctor.doctor_name||'Unknown Doctor'}</p>
              <p class="text-sm text-gray-500">Last: ${doctor.last_diagnosis||''}</p>
            </div>
          </div>
          <div class="flex flex-col items-end text-xs text-gray-500">${new Date(doctor.last_diagnosis_date).toLocaleDateString()}</div>
        </div>
      </div>
    `).join('');
  }

  async function selectDoctor(doctorEmail) {
    currentDoctorEmail = doctorEmail;
    const doctor = doctors.find(d => d.doctor_email === doctorEmail);
    populateDoctorList();
    document.getElementById("chat-doctor-name").textContent = doctor.doctor_name || 'Unknown Doctor';
    document.getElementById("chat-doctor-status").textContent = '';
    document.getElementById("message-input").disabled = false;
    document.getElementById("send-button").disabled = false;
    const roomId = `${doctorEmail.toLowerCase()}__${patientEmail.toLowerCase()}`;
    joinRoom(roomId);
    loadHistory(roomId);
  }

  function joinRoom(roomId) {
    if (currentRoomId && currentRoomId !== roomId) {
      socket.emit('leave', { room_id: currentRoomId });
    }
    currentRoomId = roomId;
    socket.emit('join', { room_id });
  }

  async function loadHistory(roomId) {
    const messagesContainer = document.getElementById("messages-container");
    messagesContainer.innerHTML = '<div class="text-center text-gray-500">Loading messages...</div>';
    try {
      const res = await fetch(`/api/messages?room_id=${encodeURIComponent(roomId)}`);
      const data = await res.json();
      if (data.success) {
        renderMessages(data.messages || []);
      } else {
        messagesContainer.innerHTML = '<div class="text-center text-red-500">Failed to load messages</div>';
      }
    } catch (e) {
      messagesContainer.innerHTML = '<div class="text-center text-red-500">Failed to load messages</div>';
    }
  }

  function renderMessages(messages) {
    const messagesContainer = document.getElementById("messages-container");
    if (!messages.length) {
      messagesContainer.innerHTML = `
        <div class="text-center text-gray-500 mt-8">
          <i class="fas fa-comments text-4xl mb-4"></i>
          <p>No messages yet. Start the conversation!</p>
        </div>`;
      return;
    }
    messagesContainer.innerHTML = messages.map(m => messageBubble(m)).join('');
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }

  function messageBubble(m) {
    const isMe = m.sender_email && m.sender_email.toLowerCase() === patientEmail.toLowerCase();
    const ts = m.timestamp ? new Date(m.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
    return `
      <div class="flex ${isMe ? 'justify-end' : 'justify-start'} mb-3">
        <div class="max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${isMe ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-900'}">
          <p class="text-sm">${escapeHtml(m.text || '')}</p>
          <p class="text-xs ${isMe ? 'text-blue-100' : 'text-gray-500'} mt-1">${ts}</p>
        </div>
      </div>`;
  }

  function escapeHtml(str) {
    return str.replace(/[&<>\"]+/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[s]));
  }

  function sendMessage() {
    const input = document.getElementById("message-input");
    const text = input.value.trim();
    if (!text || !currentRoomId) return;
    socket.emit('chat_message', {
      room_id: currentRoomId,
      text,
      sender_email: patientEmail,
      sender_role: 'patient'
    });
    input.value = '';
  }

  socket.on('chat_message', (m) => {
    if (m.room_id !== currentRoomId) return;
    const container = document.getElementById('messages-container');
    container.insertAdjacentHTML('beforeend', messageBubble(m));
    container.scrollTop = container.scrollHeight;
  });

  async function loadDoctors() {
    try {
      const res = await fetch('/api/chat-doctors');
      const data = await res.json();
      if (data.success) {
        doctors = data.doctors || [];
        populateDoctorList();
      } else {
        console.error('Failed to load doctors', data.error);
      }
    } catch (e) {
      console.error('Failed to load doctors', e);
    }
  }

  // Event listeners
  document.getElementById("send-button").addEventListener("click", sendMessage);
  document.getElementById("message-input").addEventListener("keypress", function (e) {
    if (e.key === "Enter") sendMessage();
  });
  document.getElementById("doctor-search").addEventListener("input", function() {
    const searchTerm = this.value.toLowerCase();
    const filtered = doctors.filter(d => (d.doctor_name||'').toLowerCase().includes(searchTerm) || (d.doctor_email||'').toLowerCase().includes(searchTerm));
    const backup = doctors;
    doctors = filtered;
    populateDoctorList();
    doctors = backup;
  });

  // Initialize
  document.addEventListener('DOMContentLoaded', loadDoctors);
</script>

{% endblock %}
