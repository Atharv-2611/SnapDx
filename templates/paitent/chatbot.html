{% extends 'paitent/layout/index.html' %}
{% block title %}Chatbot {% endblock %}

{% block content %}
<div class="flex h-full pt-16">
      <!-- Chat Area -->
      <div class="flex-1 flex flex-col">
        <!-- Chat Header -->
        <div class="bg-white border-b border-gray-200 px-6 py-4">
          <div class="flex items-center">
            <div class="flex-shrink-0 h-10 w-10">
              <div
                class="h-10 w-10 rounded-full bg-blue-100 flex items-center justify-center"
              >
                <i class="fas fa-robot text-blue-600"></i>
              </div>
            </div>
            <div class="ml-4">
              <h3 class="text-lg font-medium text-gray-900">
                SnapDx AI Assistant
              </h3>
              <p class="text-sm text-gray-500">Powered by Gemini AI</p>
            </div>
          </div>
        </div>

        <!-- Messages Area -->
        <div class="flex-1 overflow-y-auto p-6" id="messages-container"></div>

        <!-- Message Input -->
        <div class="bg-white border-t border-gray-200 px-6 py-4">
          <div class="flex items-center space-x-4">
            <div class="flex-1">
              <input
                type="text"
                id="message-input"
                placeholder="Type your message..."
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                disabled
              />
            </div>
            <button
              id="send-button"
              class="p-2 text-gray-400 hover:text-gray-600"
              disabled
            >
              <i class="fas fa-paper-plane"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- Consultation Panel removed for simple AI chat -->
    </div>

    <script>
      const userEmail = "{{ user_email }}";
      let conversationHistory = [];
      let conversationId = null;

      // Start a general AI chat session on load
      document.addEventListener('DOMContentLoaded', async () => {
        try {
          const res = await fetch('/api/ai/start', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({})
          });
          const data = await res.json();
          if (data.success) {
            conversationId = data.conversation_id;
            enableChat();
            addMessage('bot', "Hello! I'm your SnapDx AI Assistant. How can I help you today?");
            await loadHistory();
          } else {
            addMessage('bot', data.error || 'Unable to start AI chat right now.');
          }
        } catch (e) {
          addMessage('bot', 'Unable to start AI chat right now.');
        }
      });

      // Consultation details removed for simple chat

      // Enable chat functionality
      function enableChat() {
        document.getElementById("message-input").disabled = false;
        document.getElementById("send-button").disabled = false;
      }

      // Add message to chat
      function addMessage(sender, text) {
        const messagesContainer = document.getElementById("messages-container");
        const messageDiv = document.createElement("div");
        messageDiv.className = `flex ${
          sender === "user" ? "justify-end" : "justify-start"
        } mb-4`;

        messageDiv.innerHTML = `
                <div class="max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${
                  sender === "user"
                    ? "bg-blue-600 text-white"
                    : "bg-gray-200 text-gray-900"
                }">
                    <p class="text-sm whitespace-pre-line">${text}</p>
                </div>
            `;

        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;

        // Store in conversation history
        conversationHistory.push({ sender, text, timestamp: new Date() });
      }

      // Handle user message via backend (LangChain + Gemini)
      async function handleUserMessage(message) {
        addMessage("user", message);

        // Show typing indicator
        const typingDiv = document.createElement("div");
        typingDiv.className = "flex justify-start mb-4";
        typingDiv.innerHTML = `
                <div class="max-w-xs lg:max-w-md px-4 py-2 rounded-lg bg-gray-200 text-gray-900">
                    <div class="flex items-center space-x-2">
                        <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"></div>
                        <span class="text-sm">Gemini AI is thinking...</span>
                    </div>
                </div>
            `;
        document.getElementById("messages-container").appendChild(typingDiv);
        document.getElementById("messages-container").scrollTop =
          document.getElementById("messages-container").scrollHeight;

        try {
          const res = await fetch('/api/ai/message', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ conversation_id: conversationId, message })
          });
          const data = await res.json();

          // Remove typing indicator
          typingDiv.remove();

          if (data.success) {
            addMessage("bot", data.response);
          } else {
            addMessage("bot", data.error || 'The AI could not respond.');
          }
        } catch (error) {
          // Remove typing indicator
          typingDiv.remove();

          // Add error message
          addMessage(
            "bot",
            `I apologize, but I'm having trouble connecting to my AI service right now. Please try again in a moment, or contact your doctor for immediate assistance.`
          );

          console.error("Error getting AI response:", error);
        }
      }

      // Handle send button click
      document
        .getElementById("send-button")
        .addEventListener("click", function () {
          const input = document.getElementById("message-input");
          const message = input.value.trim();

          if (message && conversationId) {
            handleUserMessage(message);
            input.value = "";
          }
        });

      // Handle Enter key in message input
      document
        .getElementById("message-input")
        .addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            document.getElementById("send-button").click();
          }
        });

      async function loadHistory() {
        if (!conversationId) return;
        try {
          const res = await fetch(`/api/ai/messages?conversation_id=${encodeURIComponent(conversationId)}`);
          const data = await res.json();
          if (data.success) {
            for (const m of data.messages) {
              addMessage(m.sender === 'user' ? 'user' : 'bot', m.text || '');
            }
          }
        } catch (e) {
          console.error('Failed to load history', e);
        }
      }
    </script>

{% endblock %}