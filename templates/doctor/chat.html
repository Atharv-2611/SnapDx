{% extends 'doctor/layout/index.html' %}
{% block title %} Chat {% endblock %}
{% block content %}
    <!-- Welcome Header -->
    <div class="bg-blue-50 border-b border-blue-200 px-6 py-4">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold text-blue-900">Doctor Chat</h1>
                <p class="text-blue-700">Chat with patients you have diagnosed</p>
            </div>
            <div class="text-right">
                <p class="text-sm text-blue-600">Welcome, {{ user_name }}</p>
                <p class="text-xs text-blue-500">{{ user_email }}</p>
            </div>
        </div>
    </div>

    <!-- Chat Interface -->
    <div class="flex h-[calc(100vh-100px)]">
        <!-- Patient List Sidebar -->
        <div class="w-80 bg-white border-r border-gray-200 flex flex-col">
            <div class="p-4 border-b border-gray-200">
                <h2 class="text-lg font-medium text-gray-900">My Patients</h2>
                <p class="text-sm text-gray-500 mb-2">Patients diagnosed by you (unique by mobile number)</p>
                <div class="mt-2">
                    <input type="text" id="patient-search" placeholder="Search by name or phone..." 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 text-sm">
                </div>
                <div class="mt-2 flex space-x-2">
                    <button
                        onclick="debugSession()"
                        class="px-3 py-1 text-xs bg-gray-500 text-white rounded hover:bg-gray-600"
                    >
                        Debug Session
                    </button>
                    <button
                        onclick="debugDiagnoses()"
                        class="px-3 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600"
                    >
                        Debug Diagnoses
                    </button>
                </div>
            </div>
            
            <div class="flex-1 overflow-y-auto">
                <div class="divide-y divide-gray-200" id="patient-list">
                    <!-- Loading state -->
                    <div class="p-4">
                        <div class="flex items-center justify-center">
                            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
                            <span class="ml-2 text-sm text-gray-500">Loading patients...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat Area -->
        <div class="flex-1 flex flex-col">
            <!-- Chat Header -->
            <div class="bg-white border-b border-gray-200 px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="flex-shrink-0 h-10 w-10">
                            <div class="h-10 w-10 rounded-full bg-blue-100 flex items-center justify-center">
                                <i class="fas fa-user text-blue-600"></i>
                            </div>
                        </div>
                        <div class="ml-4">
                            <h3 class="text-lg font-medium text-gray-900" id="chat-patient-name">Select a patient to start chatting</h3>
                            <p class="text-sm text-gray-500" id="chat-patient-info">Click on a patient from the sidebar</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Messages Area -->
            <div class="flex-1 overflow-y-auto p-6" id="messages-container"></div>

            <!-- Message Input -->
            <div class="bg-white border-t border-gray-200 px-6 py-4">
                <div class="flex items-center space-x-4">
                    <button class="p-2 text-gray-400 hover:text-gray-600" disabled>
                        <i class="fas fa-paperclip"></i>
                    </button>
                    <div class="flex-1">
                        <input type="text" id="message-input" placeholder="Chat functionality coming soon..." 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                               disabled>
                    </div>
                    <button id="send-button" class="p-2 text-gray-400 hover:text-gray-600" disabled>
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Patient Detail Modal -->
    <div id="patient-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-900" id="modal-patient-name">Patient Details</h3>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="space-y-4" id="modal-content">
                    <!-- Patient details will be populated here -->
                </div>
                
                <div class="flex justify-end space-x-3 mt-6">
                    <button onclick="closeModal()" class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">
                        Close
                    </button>
                    <button onclick="viewPatientHistory()" class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">
                        View History
                    </button>
                </div>
            </div>
        </div>
    </div>

            <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        let patients = [];
        let currentPatient = null;
        let filteredPatients = [];
        const doctorEmail = "{{ user_email }}";
        const socket = io();
        let currentRoomId = null;

        // Fetch patients from backend
        async function fetchPatients() {
            try {
                console.log('Fetching patients for logged-in doctor...');
                const response = await fetch('/api/chat-patients');
                const data = await response.json();
                console.log('Response from /api/chat-patients:', data);
                
                if (data.success) {
                    patients = data.patients;
                    filteredPatients = [...patients];
                    console.log(`Loaded ${patients.length} patients diagnosed by the doctor:`, patients);
                    populatePatientList();
                } else {
                    console.error('Error fetching patients:', data.error);
                    showError('Failed to load patients: ' + data.error);
                }
            } catch (error) {
                console.error('Error:', error);
                showError('Failed to load patients');
            }
        }

        // Populate patient list
        function populatePatientList() {
            const patientList = document.getElementById('patient-list');
            
            if (filteredPatients.length === 0) {
                patientList.innerHTML = `
                    <div class="p-4">
                        <div class="flex flex-col items-center text-center">
                            <i class="fas fa-users text-gray-400 text-2xl mb-2"></i>
                            <p class="text-sm text-gray-500">No patients found</p>
                            <p class="text-xs text-gray-400">You haven't diagnosed any patients yet</p>
                            <p class="text-xs text-gray-400 mt-1">Start by creating your first diagnosis</p>
                        </div>
                    </div>
                `;
                return;
            }

            patientList.innerHTML = filteredPatients.map(patient => {
                const timeAgo = getTimeAgo(new Date(patient.last_diagnosis_date));
                const colorClasses = getColorClasses(patient.has_disease);
                const isSelected = currentPatient && currentPatient.phone === patient.phone;
                
                return `
                    <div class="p-4 hover:bg-gray-50 cursor-pointer border-l-4 border-transparent ${isSelected ? 'border-blue-500 bg-blue-50' : ''}" 
                         onclick="selectPatient('${patient.phone}')">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 h-10 w-10">
                                    <div class="h-10 w-10 rounded-full ${colorClasses.bg} flex items-center justify-center">
                                        <span class="text-sm font-medium ${colorClasses.text}">${patient.name.charAt(0).toUpperCase()}</span>
                                    </div>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm font-medium text-gray-900">${patient.name}</p>
                                    <p class="text-sm text-gray-500">${patient.phone}</p>
                                </div>
                            </div>
                            <div class="flex flex-col items-end">
                                <span class="inline-flex items-center px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded-full mb-1">
                                    <span class="w-2 h-2 bg-green-400 rounded-full mr-1"></span>
                                    Online
                                </span>
                                <p class="text-xs text-gray-500">${timeAgo}</p>
                                <span class="inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-white bg-blue-500 rounded-full">
                                    ${patient.total_diagnoses}
                                </span>
                            </div>
                        </div>
                        <div class="mt-2">
                            <p class="text-xs text-gray-500">Last: ${patient.last_diagnosis}</p>
                            <div class="flex items-center justify-between mt-1">
                                <div class="flex items-center">
                                    <div class="w-2 h-2 rounded-full ${patient.has_disease ? 'bg-red-400' : 'bg-green-400'}"></div>
                                    <span class="text-xs text-gray-500 ml-2">${patient.has_disease ? 'Positive' : 'Negative'} (${patient.confidence}%)</span>
                                </div>
                                <span class="text-xs text-blue-600 font-medium">${patient.report_id || ''}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Select patient
        function selectPatient(phone) {
            currentPatient = patients.find(p => p.phone === phone);
            populatePatientList();
            
            // Update chat header
            document.getElementById('chat-patient-name').textContent = currentPatient.name;
            document.getElementById('chat-patient-info').textContent = `${currentPatient.phone} • ${currentPatient.total_diagnoses} diagnosis${currentPatient.total_diagnoses > 1 ? 'es' : ''}`;
            
            // Enable message input
            document.getElementById('message-input').disabled = false;
            document.getElementById('send-button').disabled = false;

            // Connect room and load messages
            const roomId = computeRoomId(currentPatient);
            joinRoom(roomId);
            loadHistory(roomId);
        }

        function computeRoomId(patient) {
            const patientKey = (patient.email && patient.email.length)
                ? patient.email
                : (patient.phone && patient.phone.length ? patient.phone : patient.patient_id);
            return `${doctorEmail.toLowerCase()}__${patientKey.toLowerCase()}`;
        }

        function joinRoom(roomId) {
            if (currentRoomId && currentRoomId !== roomId) {
                socket.emit('leave', { room_id: currentRoomId });
            }
            currentRoomId = roomId;
            socket.emit('join', { room_id: roomId });
        }

        async function loadHistory(roomId) {
            const messagesContainer = document.getElementById('messages-container');
            messagesContainer.innerHTML = '<div class="text-center text-gray-500">Loading messages...</div>';
            try {
                const res = await fetch(`/api/messages?room_id=${encodeURIComponent(roomId)}`);
                const data = await res.json();
                if (data.success) {
                    renderMessages(data.messages || []);
                } else {
                    messagesContainer.innerHTML = '<div class="text-center text-red-500">Failed to load messages</div>';
                }
            } catch (e) {
                messagesContainer.innerHTML = '<div class="text-center text-red-500">Failed to load messages</div>';
            }
        }

        function renderMessages(messages) {
            const messagesContainer = document.getElementById('messages-container');
            if (!messages.length) {
                messagesContainer.innerHTML = `
                    <div class="text-center text-gray-500 mt-8">
                        <i class="fas fa-comments text-4xl mb-4"></i>
                        <p>No messages yet. Start the conversation!</p>
                    </div>
                `;
                return;
            }
            messagesContainer.innerHTML = messages.map(m => messageBubble(m)).join('');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function messageBubble(m) {
            const isMe = m.sender_email && m.sender_email.toLowerCase() === doctorEmail.toLowerCase();
            const ts = m.timestamp ? formatTimestamp(new Date(m.timestamp)) : '';
            return `
                <div class="flex ${isMe ? 'justify-end' : 'justify-start'} mb-3">
                    <div class="max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${isMe ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-900'}">
                        <p class="text-sm">${escapeHtml(m.text || '')}</p>
                        <p class="text-xs ${isMe ? 'text-blue-100' : 'text-gray-500'} mt-1">${ts}</p>
                    </div>
                </div>
            `;
        }

        function formatTimestamp(date) {
            const now = new Date();
            const diffInMinutes = Math.floor((now - date) / (1000 * 60));
            
            if (diffInMinutes < 1) {
                return 'Just now';
            } else if (diffInMinutes < 60) {
                return `${diffInMinutes}m ago`;
            } else if (diffInMinutes < 1440) {
                const hours = Math.floor(diffInMinutes / 60);
                return `${hours}h ago`;
            } else {
                return date.toLocaleDateString();
            }
        }

        function escapeHtml(str) {
            return str.replace(/[&<>"]+/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[s]));
        }

        async function sendMessage() {
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            if (!text || !currentRoomId) return;
            
            // Add message to UI immediately
            const messageData = {
                room_id: currentRoomId,
                text,
                sender_email: doctorEmail,
                sender_role: 'doctor',
                timestamp: new Date().toISOString()
            };
            
            // Add to UI
            const container = document.getElementById('messages-container');
            container.insertAdjacentHTML('beforeend', messageBubble(messageData));
            container.scrollTop = container.scrollHeight;
            
            // Send via socket
            socket.emit('chat_message', messageData);
            input.value = '';
        }

        socket.on('chat_message', (m) => {
            if (m.room_id !== currentRoomId) return;
            const container = document.getElementById('messages-container');
            container.insertAdjacentHTML('beforeend', messageBubble(m));
            container.scrollTop = container.scrollHeight;
        });

        // Show typing indicator when patient is typing
        socket.on('typing', (data) => {
            if (data.room_id !== currentRoomId) return;
            showTypingIndicator('Patient is typing...');
        });

        socket.on('stop_typing', (data) => {
            if (data.room_id !== currentRoomId) return;
            hideTypingIndicator();
        });

        // Add typing indicator functions
        function showTypingIndicator(message) {
            let typingDiv = document.getElementById('typing-indicator');
            if (!typingDiv) {
                typingDiv = document.createElement('div');
                typingDiv.id = 'typing-indicator';
                typingDiv.className = 'flex justify-start mb-3';
                typingDiv.innerHTML = `
                    <div class="max-w-xs lg:max-w-md px-4 py-2 rounded-lg bg-gray-200 text-gray-900">
                        <div class="flex items-center space-x-2">
                            <div class="flex space-x-1">
                                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                            </div>
                            <span class="text-sm text-gray-600">${message}</span>
                        </div>
                    </div>
                `;
                document.getElementById('messages-container').appendChild(typingDiv);
            }
            typingDiv.style.display = 'block';
            document.getElementById('messages-container').scrollTop = document.getElementById('messages-container').scrollHeight;
        }

        function hideTypingIndicator() {
            const typingDiv = document.getElementById('typing-indicator');
            if (typingDiv) {
                typingDiv.style.display = 'none';
            }
        }

        // Emit typing events
        let typingTimer;
        document.getElementById('message-input').addEventListener('input', function() {
            if (currentRoomId) {
                socket.emit('typing', { room_id: currentRoomId });
                clearTimeout(typingTimer);
                typingTimer = setTimeout(() => {
                    socket.emit('stop_typing', { room_id: currentRoomId });
                }, 1000);
            }
        });

        // View patient details in modal
        function viewPatientDetails(phone) {
            const patient = patients.find(p => p.phone === phone);
            if (!patient) return;
            
            document.getElementById('modal-patient-name').textContent = patient.name;
            document.getElementById('modal-content').innerHTML = `
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <h4 class="font-medium text-gray-900">Patient Information</h4>
                        <p class="text-sm text-gray-600">Name: ${patient.name}</p>
                        <p class="text-sm text-gray-600">Phone: ${patient.phone}</p>
                        <p class="text-sm text-gray-600">Age: ${patient.age || 'Not specified'}</p>
                        <p class="text-sm text-gray-600">Gender: ${patient.gender || 'Not specified'}</p>
                    </div>
                    <div>
                        <h4 class="font-medium text-gray-900">Diagnosis Summary</h4>
                        <p class="text-sm text-gray-600">Total Diagnoses: ${patient.total_diagnoses}</p>
                        <p class="text-sm text-gray-600">Last Diagnosis: ${patient.last_diagnosis}</p>
                        <p class="text-sm text-gray-600">Last Date: ${new Date(patient.last_diagnosis_date).toLocaleDateString()}</p>
                        <p class="text-sm text-gray-600">Status: <span class="font-medium ${patient.has_disease ? 'text-red-600' : 'text-green-600'}">${patient.has_disease ? 'Positive' : 'Negative'}</span></p>
                    </div>
                </div>
                <div class="mt-4">
                    <h4 class="font-medium text-gray-900">Recent Activity</h4>
                    <p class="text-sm text-gray-600">Last diagnosis was ${getTimeAgo(new Date(patient.last_diagnosis_date))}</p>
                    <p class="text-sm text-gray-600">Confidence level: ${patient.confidence}%</p>
                </div>
            `;
            
            document.getElementById('patient-modal').classList.remove('hidden');
        }

        // Close modal
        function closeModal() {
            document.getElementById('patient-modal').classList.add('hidden');
        }

        // View patient history (redirect to history page)
        function viewPatientHistory() {
            window.location.href = "{{ url_for('doctor_history') }}";
        }

        // Search patients
        function searchPatients() {
            const searchTerm = document.getElementById('patient-search').value.toLowerCase();
            filteredPatients = patients.filter(patient => 
                patient.name.toLowerCase().includes(searchTerm) ||
                patient.phone.includes(searchTerm)
            );
            populatePatientList();
        }

        // Helper function to get time ago
        function getTimeAgo(date) {
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);
            
            if (diffInSeconds < 60) {
                return 'Just now';
            } else if (diffInSeconds < 3600) {
                const minutes = Math.floor(diffInSeconds / 60);
                return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
            } else if (diffInSeconds < 86400) {
                const hours = Math.floor(diffInSeconds / 3600);
                return `${hours} hour${hours > 1 ? 's' : ''} ago`;
            } else {
                const days = Math.floor(diffInSeconds / 86400);
                return `${days} day${days > 1 ? 's' : ''} ago`;
            }
        }

        // Helper function to get color classes based on diagnosis
        function getColorClasses(hasDisease) {
            if (hasDisease) {
                return {
                    bg: 'bg-red-100',
                    text: 'text-red-600'
                };
            } else {
                return {
                    bg: 'bg-green-100',
                    text: 'text-green-600'
                };
            }
        }

        // Show error message
        function showError(message) {
            const patientList = document.getElementById('patient-list');
            patientList.innerHTML = `
                <div class="p-4">
                    <div class="flex items-center justify-center text-red-500">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        <span class="text-sm">${message}</span>
                    </div>
                </div>
            `;
        }

        // Event listeners
        document.getElementById('patient-search').addEventListener('input', searchPatients);
        document.getElementById('send-button').addEventListener('click', sendMessage);
        document.getElementById('message-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') sendMessage();
        });

        // Debug functions
        async function debugSession() {
            try {
                const res = await fetch('/api/debug/session');
                const data = await res.json();
                console.log('Session Debug:', data);
                alert(`Session Debug:\nEmail: ${data.user_email}\nRole: ${data.user_role}\nName: ${data.user_name}`);
            } catch (e) {
                console.error('Debug session error:', e);
                alert('Debug session error: ' + e.message);
            }
        }

        async function debugDiagnoses() {
            try {
                const res = await fetch('/api/debug/diagnoses');
                const data = await res.json();
                console.log('Diagnoses Debug:', data);
                alert(`Diagnoses Debug:\nFound: ${data.diagnoses_count} diagnoses\nCheck console for details`);
            } catch (e) {
                console.error('Debug diagnoses error:', e);
                alert('Debug diagnoses error: ' + e.message);
            }
        }

        // Load patients when page loads
        document.addEventListener('DOMContentLoaded', function() {
            fetchPatients();
        });
    </script>

{% endblock %}
